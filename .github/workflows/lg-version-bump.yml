name: LG Version Bump

on:
  workflow_dispatch:
    inputs:
      dry_run:
        type: boolean
        default: false
        description: 'ê¸°ëŠ¥ê²€ì¦ ëª¨ë“œ: ë¡œì§ ê²€ì¦ë§Œ í•˜ê³  commit/push í•˜ì§€ ì•ŠìŒ'

permissions:
  contents: write

concurrency:
  group: lg-version-bump
  cancel-in-progress: false

jobs:
  version_bump:
    name: LG Version Bump
    runs-on: ubuntu-latest

    steps:
      - name: Checkout current branch
        uses: actions/checkout@v5
        with:
          fetch-depth: 0
          token: ${{ github.token }}

      - name: Set up git user
        run: |
          git config --local user.email "test@test.com"
          git config --local user.name "Test Bot"

      - name: Determine branch context
        id: context
        run: |
          CURRENT_BRANCH="${GITHUB_REF#refs/heads/}"
          echo "current_branch=$CURRENT_BRANCH" >> $GITHUB_OUTPUT
          if [ "$CURRENT_BRANCH" = "next-lg" ]; then
            echo "is_next_lg=true" >> $GITHUB_OUTPUT
          else
            echo "is_next_lg=false" >> $GITHUB_OUTPUT
          fi
          echo "ðŸ“Œ Current branch: $CURRENT_BRANCH"

      - name: Determine target base version
        id: base
        run: |
          IS_NEXT_LG="${{ steps.context.outputs.is_next_lg }}"

          if [ "$IS_NEXT_LG" = "true" ]; then
            # next-lg: ë§ˆì§€ë§‰ ë¼ì¸(ìµœì‹  base version) ì‚¬ìš©
            TARGET_LINE=$(git show origin/next-lg:version | grep -v '^\s*$' | tail -1)
          else
            # release/*: ìžê¸° ë¸Œëžœì¹˜ì˜ version íŒŒì¼ì—ì„œ base í™•ì¸
            MY_VERSION=$(cat version | tr -d '[:space:]')
            if [[ "$MY_VERSION" =~ ^([0-9]+\.[0-9]+\.[0-9]+)-lg ]]; then
              MY_BASE="${BASH_REMATCH[1]}"
            else
              echo "âŒ Invalid version format in current branch: $MY_VERSION"
              exit 1
            fi
            # next-lgì—ì„œ ê°™ì€ baseë¥¼ ê°€ì§„ ë¼ì¸ ì°¾ê¸°
            TARGET_LINE=$(git show origin/next-lg:version | grep "^${MY_BASE}-lg")
            if [ -z "$TARGET_LINE" ]; then
              echo "âŒ Base version $MY_BASE not found in next-lg version file"
              echo "   next-lg version file contents:"
              git show origin/next-lg:version
              exit 1
            fi
          fi

          echo "ðŸ“– Target line: $TARGET_LINE"
          echo "target_line=$TARGET_LINE" >> $GITHUB_OUTPUT

      - name: Read and validate version
        id: version
        run: |
          TARGET_LINE="${{ steps.base.outputs.target_line }}"

          # Format: X.Y.Z-lg or X.Y.Z-lg.N
          if [[ "$TARGET_LINE" =~ ^([0-9]+\.[0-9]+\.[0-9]+)-lg(\.([0-9]+))?$ ]]; then
            BASE="${BASH_REMATCH[1]}"
            N="${BASH_REMATCH[3]:-0}"
            NEW_N=$((N + 1))
            NEW_VERSION="${BASE}-lg.${NEW_N}"

            echo "base=$BASE" >> $GITHUB_OUTPUT
            echo "current_version=$TARGET_LINE" >> $GITHUB_OUTPUT
            echo "new_version=$NEW_VERSION" >> $GITHUB_OUTPUT
            echo "âœ… Valid format: base=$BASE, n=$N â†’ new n=$NEW_N"
            echo "ðŸ†• New version: $NEW_VERSION"
          else
            echo "âŒ Invalid version format: $TARGET_LINE"
            echo "   Expected: {X.Y.Z}-lg or {X.Y.Z}-lg.{n}"
            exit 1
          fi

      - name: Update next-lg version file
        if: inputs.dry_run == false
        run: |
          CURRENT_VERSION="${{ steps.version.outputs.current_version }}"
          NEW_VERSION="${{ steps.version.outputs.new_version }}"

          git checkout -B next-lg origin/next-lg

          # í•´ë‹¹ ë¼ì¸ë§Œ êµì²´
          sed -i "s|^${CURRENT_VERSION}$|${NEW_VERSION}|" version

          git add version
          git commit -m "chore(release): bump version to ${NEW_VERSION} (from ${{ steps.context.outputs.current_branch }})"
          git push origin next-lg
          echo "âœ… next-lg version updated: ${CURRENT_VERSION} â†’ ${NEW_VERSION}"

      - name: Update current branch version
        if: inputs.dry_run == false && steps.context.outputs.is_next_lg == 'false'
        run: |
          CURRENT_BRANCH="${{ steps.context.outputs.current_branch }}"
          NEW_VERSION="${{ steps.version.outputs.new_version }}"

          git checkout "$CURRENT_BRANCH"

          # ëª¨ë¸ ë¸Œëžœì¹˜ëŠ” ë‹¨ì¼ ë¼ì¸
          echo "$NEW_VERSION" > version

          git add version
          git commit -m "chore(release): bump version to ${NEW_VERSION}"
          git push origin "$CURRENT_BRANCH"
          echo "âœ… $CURRENT_BRANCH version updated"

      - name: Summary
        run: |
          {
            echo "## LG Version Bump"
            echo ""
            if [ "${{ inputs.dry_run }}" = "true" ]; then
              echo "### ðŸ” Dry Run (commit/push í•˜ì§€ ì•ŠìŒ)"
            else
              echo "### âœ… Complete"
            fi
            echo ""
            echo "| í•­ëª© | ê°’ |"
            echo "|------|-----|"
            echo "| Base Version | \`${{ steps.version.outputs.base }}\` |"
            echo "| ì´ì „ ë²„ì „ | \`${{ steps.version.outputs.current_version }}\` |"
            echo "| ìƒˆ ë²„ì „ | \`${{ steps.version.outputs.new_version }}\` |"
            echo "| ì‹¤í–‰ ë¸Œëžœì¹˜ | \`${{ steps.context.outputs.current_branch }}\` |"
            if [ "${{ steps.context.outputs.is_next_lg }}" = "true" ]; then
              echo "| ì—…ë°ì´íŠ¸ ëŒ€ìƒ | next-lg |"
            else
              echo "| ì—…ë°ì´íŠ¸ ëŒ€ìƒ | next-lg + \`${{ steps.context.outputs.current_branch }}\` |"
            fi
          } >> $GITHUB_STEP_SUMMARY
